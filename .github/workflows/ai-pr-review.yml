# AI 自动审查 PR（OpenAI）
name: AI 自动审查 PR（OpenAI）
on:
  pull_request:
    types: [opened, edited, reopened, synchronize, ready_for_review]

jobs:
  ai-pr-review:
    runs-on: ubuntu-latest

    # if: github.event.pull_request.head.repo.full_name == github.repository

    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare diff (limit size)
        id: prepare
        run: |
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"
          git fetch origin "$BASE" "$HEAD" || true
          git diff --unified=0 "$BASE" "$HEAD" > pr.diff || true
          head -c 20000 pr.diff > pr_limited.diff || true
          DIFF_CONTENT=$(sed 's/"/\\"/g; s/$/\\n/' pr_limited.diff | tr -d '\r' | sed ':a;N;$!ba;s/\n/\\n/g')
          echo "DIFF<<EOF" >> $GITHUB_OUTPUT
          echo -e "$DIFF_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Call OpenAI to review diff
        id: ai
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -uxo pipefail
          if [ -z "${{ steps.prepare.outputs.DIFF }}" ]; then
            echo "comment_body<<EOF" >> $GITHUB_OUTPUT
            echo "No diff or diff too large." >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 0
          fi

          # for test
          echo "curl start"
          curl -v https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "{
              \"model\": \"gpt-4o-mini\",
              \"messages\": [
                {\"role\":\"system\",\"content\":\"$SYSTEM\"},
                {\"role\":\"user\",\"content\":\"$USER\"}
              ],
              \"temperature\": 0.2,
              \"max_tokens\": 2000
            }"
          echo "curl end"
