# AI è‡ªåŠ¨å®¡æŸ¥ PRï¼ˆOpenAIï¼‰
name: AI è‡ªåŠ¨å®¡æŸ¥ PRï¼ˆOpenAIï¼‰
on:
  pull_request:
    types: [opened, edited, reopened, synchronize, ready_for_review]

jobs:
  ai-pr-review:
    runs-on: ubuntu-latest

    # if: github.event.pull_request.head.repo.full_name == github.repository

    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare diff (limit size)
        id: prepare
        run: |
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"
          git fetch origin "$BASE" "$HEAD" || true
          git diff --unified=0 "$BASE" "$HEAD" > pr.diff || true
          head -c 20000 pr.diff > pr_limited.diff || true
          DIFF_CONTENT=$(sed 's/"/\\"/g; s/$/\\n/' pr_limited.diff | tr -d '\r' | sed ':a;N;$!ba;s/\n/\\n/g')
          echo "DIFF<<EOF" >> $GITHUB_OUTPUT
          echo -e "$DIFF_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Call OpenAI to review diff
        id: ai
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "${{ steps.prepare.outputs.DIFF }}" ]; then
            echo "comment_body<<EOF" >> $GITHUB_OUTPUT
            echo "No diff or diff too large." >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 0
          fi

          SYSTEM='ä½ æ˜¯ä¸“ä¸šçš„ C/C++ åŽç«¯ä»£ç å®¡æŸ¥æœºå™¨äººï¼ŒåŒæ—¶ä½ ä¹Ÿæ˜¯llbcæ¡†æž¶çš„ä¸“å®¶ï¼ˆè¯·è¯¦ç»†å­¦ä¹ llbcæ¡†æž¶: https://github.com/lailongwei/llbcï¼‰ï¼Œè¯·åŸºäºŽä¸‹é¢çš„ diff æå‡ºé—®é¢˜ã€æ½œåœ¨ bugã€æ€§èƒ½/å®‰å…¨/å¹¶å‘éšæ‚£ã€ä»¥åŠå¯è¡Œä¿®å¤å»ºè®®ã€‚æŒ‰æ–‡ä»¶ç»„ç»‡è¾“å‡ºã€‚'
          USER="Diff:\n${{ steps.prepare.outputs.DIFF }}"
          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "{
              \"model\": \"gpt-4o-mini\",
              \"messages\": [
                {\"role\":\"system\",\"content\":\"$SYSTEM\"},
                {\"role\":\"user\",\"content\":\"$USER\"}
              ],
              \"temperature\": 0.2,
              \"max_tokens\": 2000
            }")
          REVIEW_TEXT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content' 2>/dev/null || echo "AI æœªè¿”å›žå†…å®¹")
          echo "comment_body<<EOF" >> $GITHUB_OUTPUT
          echo -e "### ðŸ¤– AI è‡ªåŠ¨å®¡æŸ¥\n\n$REVIEW_TEXT\n\n*AI å»ºè®®ä»…ä¾›å‚è€ƒï¼Œè¯·äººå·¥å¤æ ¸ã€‚*" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.ai.outputs.comment_body }}
          edit-mode: replace
